<%
   new_params = params.clone
   new_params.merge!({:controller => "spree/products", :action => "show" , :id => product.slug}).permit!.to_h #i think this permit here is a segurity issue
   category = params[:car_category]
%>
<li id="product_<%= product.id %>" class="col-md-12 product-item" data-hook2="product_<%=product.product_type.name%>" data-hook="products_list_item" itemscope itemtype="http://schema.org/Product">
  <div class="row">
    <div class="col-12 col-sm-4 product-img-cont">
      <%= link_to small_image(product, itemprop: "image", class:"img-fluid"), new_params %>
    </div>
    <div class="col-12 col-sm-8">
      <div class="row">
        <div class="col-12 col-sm-8 col-md-7 col-lg-8">
          <div class="product-title">
            <%= link_to(new_params, class: 'info', itemprop: "name", title: product.name) do %>
              <%= product.name %>
            <%end%>
          </div>
          <div class="product-mini-description">
            <%= truncate(product.description, length: 150)%>
          </div>
        </div>
        <div class="col-12 col-sm-4 col-md-5 col-lg-4">
          <div class="price-details mt-2">
            <div>
              <div class="class-type">
                <%= category.to_i == 0 ? category : Spree::OptionValue.find(category.to_i).presentation %>
              </div>
              <%
                if category.to_i == 0
                  hash = display_travel_price(variant: product.variants.joins(:option_values).where(spree_option_values: {presentation: category}).first)
                else
                  hash = display_travel_price(variant: product.variants.where(product: product.id).includes(:option_values).where(spree_option_values: {id: category.to_i}).first)
                end
              %>
              <% if hash.present? && hash.first[:variant].can_supply? %>
                  <span class="price">Price:<%= hash.first[:price]%> </span>
                  <%= render partial:'spree/products/product_type_cart_form', locals: {product: product,
                                                                                       variant_id: hash.first[:variant].id,
                                                                                       rate_id: hash.first[:rate]} %>

              <%else%>
                <span class="out-of-stock"><%= Spree.t(:out_of_stock) %></span>
              <%end%>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</li>


